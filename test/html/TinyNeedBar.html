<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TinyNeedBar Tester</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, sans-serif;
        margin: 0;
        background: #f4f6f9;
        color: #333;
      }

      header {
        background: #2c3e50;
        color: #fff;
        padding: 1rem 2rem;
        font-size: 1.2rem;
        font-weight: bold;
      }

      main {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 1rem;
        padding: 1rem 2rem;
      }

      section {
        background: #fff;
        border-radius: 6px;
        padding: 1rem;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      }

      h2 {
        font-size: 1rem;
        margin: 0 0 0.5rem 0;
        border-bottom: 1px solid #ddd;
        padding-bottom: 0.3rem;
      }

      label {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.9rem;
      }

      input,
      select,
      button,
      textarea {
        width: 100%;
        margin-top: 0.2rem;
        padding: 0.4rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 0.9rem;
      }

      button {
        cursor: pointer;
        background: #3498db;
        color: white;
        border: none;
        transition: background 0.2s;
      }

      button:hover {
        background: #2980b9;
      }

      .need-bar {
        margin: 0.5rem 0;
      }

      .progress {
        height: 20px;
        background: #ddd;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.3rem;
      }

      .progress-inner {
        height: 100%;
        background: #2ecc71;
        transition: width 0.2s ease;
      }

      .bar-details {
        font-size: 0.8rem;
        display: flex;
        justify-content: space-between;
      }

      .factors-list {
        margin-top: 0.5rem;
        font-size: 0.8rem;
        border-top: 1px solid #eee;
        padding-top: 0.5rem;
      }

      .log {
        background: #1e272e;
        color: #d2dae2;
        font-family: monospace;
        padding: 0.5rem;
        height: 200px;
        overflow-y: auto;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <header>ðŸ§ª TinyNeedBar Tester</header>

    <main>
      <!-- Controls -->
      <section>
        <h2>Create / Configure Bar</h2>
        <label>Max Value <input type="number" id="maxValue" value="100" /></label>
        <label>Base Decay <input type="number" id="baseDecay" value="1" /></label>
        <label>Base Multiplier <input type="number" id="baseMulti" value="1" /></label>
        <button id="createBar">Create Bar</button>
      </section>

      <!-- Display -->
      <section>
        <h2>Need Bar Status</h2>
        <div id="needBars"></div>
      </section>

      <!-- Factors -->
      <section>
        <h2>Manage Factors</h2>
        <label>Key <input type="text" id="factorKey" /></label>
        <label>Amount <input type="number" id="factorAmount" /></label>
        <label>Multiplier <input type="number" id="factorMulti" value="1" /></label>
        <button id="addFactor">Add / Update Factor</button>
        <button id="removeFactor">Remove Factor</button>
      </section>

      <!-- Actions -->
      <section>
        <h2>Simulation</h2>
        <button id="tickOnce">Tick Once</button>
        <button id="startAuto">Start Auto Tick</button>
        <button id="stopAuto">Stop Auto Tick</button>
        <button id="resetBar">Reset Bar</button>
      </section>

      <!-- JSON -->
      <section>
        <h2>Serialization</h2>
        <button id="exportJson">Export JSON</button>
        <button id="importJson">Import JSON</button>
        <textarea id="jsonArea" rows="6"></textarea>
      </section>

      <!-- Logs -->
      <section style="grid-column: 1 / span 2">
        <h2>Logs</h2>
        <div id="log" class="log"></div>
      </section>
    </main>

    <script type="module">
      import { TinyNeedBar } from './src/v1/libs/TinyNeedBar.mjs';

      window.TinyNeedBar = TinyNeedBar;
      let bar = null;
      let autoInterval = null;

      const logEl = document.getElementById('log');
      const needBarsEl = document.getElementById('needBars');

      function log(msg) {
        const time = new Date().toLocaleTimeString();
        logEl.innerHTML += `[${time}] ${msg}<br>`;
        logEl.scrollTop = logEl.scrollHeight;
      }

      function renderBar() {
        if (!bar) return;
        needBarsEl.innerHTML = '';

        const wrapper = document.createElement('div');
        wrapper.className = 'need-bar';

        const progress = document.createElement('div');
        progress.className = 'progress';

        const inner = document.createElement('div');
        inner.className = 'progress-inner';
        inner.style.width = bar.currentPercent + '%';
        progress.appendChild(inner);

        const details = document.createElement('div');
        details.className = 'bar-details';
        details.innerHTML = `
        <span>Value: ${bar.currentValue.toFixed(2)} / ${bar.maxValue}</span>
        <span>${bar.currentPercent.toFixed(1)}%</span>
      `;

        const factors = document.createElement('div');
        factors.className = 'factors-list';
        factors.innerHTML =
          '<b>Factors:</b><br>' +
          Object.entries(bar.factors)
            .map(([k, f]) => `${k}: amount=${f.amount}, multiplier=${f.multiplier}`)
            .join('<br>');

        wrapper.appendChild(progress);
        wrapper.appendChild(details);
        wrapper.appendChild(factors);

        needBarsEl.appendChild(wrapper);
      }

      // Controls
      document.getElementById('createBar').onclick = () => {
        const maxValue = +document.getElementById('maxValue').value;
        const baseDecay = +document.getElementById('baseDecay').value;
        const baseMulti = +document.getElementById('baseMulti').value;

        bar = new TinyNeedBar(maxValue, baseDecay, baseMulti);
        window.barStatus = bar;
        log('Created new bar');
        renderBar();
      };

      document.getElementById('addFactor').onclick = () => {
        if (!bar) return;
        const key = document.getElementById('factorKey').value;
        const amount = +document.getElementById('factorAmount').value;
        const multi = +document.getElementById('factorMulti').value;
        bar.setFactor(key, amount, multi);
        log(`Set factor "${key}" (amount=${amount}, multiplier=${multi})`);
        renderBar();
      };

      document.getElementById('removeFactor').onclick = () => {
        if (!bar) return;
        const key = document.getElementById('factorKey').value;
        bar.removeFactor(key);
        log(`Removed factor "${key}"`);
        renderBar();
      };

      document.getElementById('tickOnce').onclick = () => {
        if (!bar) return;
        const result = bar.tick();
        log(`Tick: -${result.removedTotal} (â†’ ${result.remainingValue})`);
        renderBar();
      };

      document.getElementById('startAuto').onclick = () => {
        if (!bar || autoInterval) return;
        autoInterval = setInterval(() => {
          const result = bar.tick();
          log(`Auto tick: -${result.removedTotal} (â†’ ${result.remainingValue})`);
          renderBar();
        }, 1000);
        log('Started auto tick');
      };

      document.getElementById('stopAuto').onclick = () => {
        clearInterval(autoInterval);
        autoInterval = null;
        log('Stopped auto tick');
      };

      document.getElementById('resetBar').onclick = () => {
        if (!bar) return;
        bar.infiniteValue = bar.maxValue;
        log('Bar reset to max');
        renderBar();
      };

      document.getElementById('exportJson').onclick = () => {
        if (!bar) return;
        document.getElementById('jsonArea').value = JSON.stringify(bar.toJSON(), null, 2);
        log('Exported JSON');
      };

      document.getElementById('importJson').onclick = () => {
        const raw = document.getElementById('jsonArea').value;
        if (!raw) return;
        try {
          const data = JSON.parse(raw);
          bar = TinyNeedBar.fromJSON(data);
          log('Imported JSON');
          renderBar();
        } catch (e) {
          log('Error importing JSON: ' + e.message);
        }
      };
    </script>
  </body>
</html>
