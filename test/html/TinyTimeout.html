<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TinyTimeout Tester</title>
    <script type="module">
      import { TinyTimeout } from './src/v1/libs/TinyTimeout.mjs';
      window.TinyTimeout = TinyTimeout;
    </script>
    <style>
      body {
        font-family: sans-serif;
        background: #121212;
        color: #fff;
        padding: 2rem;
      }
      h1,
      h2 {
        color: #90caf9;
      }
      .section {
        margin-bottom: 2rem;
        padding: 1rem;
        background: #1e1e1e;
        border-radius: 10px;
      }
      .row {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
      }
      input[type='number'],
      input[type='text'] {
        background: #333;
        color: #fff;
        border: 1px solid #555;
        padding: 0.3rem 0.6rem;
        border-radius: 5px;
        width: 100px;
      }
      button {
        padding: 0.4rem 1rem;
        background: #2196f3;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      button:disabled {
        background: #555;
      }
      .bar {
        height: 16px;
        background: #64ffda;
        border-radius: 5px;
        transition: width 0.2s ease;
      }
      .bar-container {
        background: #333;
        width: 200px;
        border-radius: 5px;
        overflow: hidden;
        margin-left: 0.5rem;
      }
      .id-panel {
        margin-top: 1rem;
      }
      .id-panel div {
        margin-bottom: 0.3rem;
      }
    </style>
  </head>
  <body>
    <h1>TinyTimeout Test Suite</h1>

    <div class="section">
      <h2>Configuration</h2>
      <div class="row">
        <label>Cooldown Interval (ms):</label>
        <input id="cooldownInterval" type="number" value="5000" />
      </div>
      <div class="row">
        <label><input type="checkbox" id="autoConfigChange" /> Allow Auto Config Change</label>
      </div>
      <button onclick="init()">(Re)Initialize TinyTimeout</button>
      <button onclick="destroy()">Destroy Instance</button>
      <div>Current State: <span id="instanceStatus">Not Initialized</span></div>
    </div>

    <div class="section">
      <h2>Test Trigger</h2>
      <div class="row">
        <input id="testId" type="text" placeholder="ID (e.g. actionA)" />
        <input id="testValue" type="number" placeholder="Value" value="1000" />
        <input id="testLimit" type="number" placeholder="Limit (optional)" />
        <button onclick="trigger()">Trigger</button>
      </div>
      <div class="id-panel" id="idStates"></div>
    </div>

    <div class="section">
      <h2>Live Visualization</h2>
      <div id="visualizer"></div>
    </div>

    <div class="section">
      <h2>Polling Test</h2>
      <button onclick="pollDemo()">Run poll until variable hits 5</button>
      <div id="pollResult"></div>
    </div>

    <script type="module">
      let instance = null;
      let data = {};

      function init() {
        const cooldown = parseInt(document.getElementById('cooldownInterval').value, 10);
        const autoChange = document.getElementById('autoConfigChange').checked;

        if (instance) instance.destroy();
        instance = new TinyTimeout({
          cooldownWatcherTime: cooldown,
          allowAutoConfigChange: autoChange,
        });
        data = {};
        document.getElementById('visualizer').innerHTML = '';
        document.getElementById('idStates').innerHTML = '';
        document.getElementById('instanceStatus').textContent = 'Active';
      }

      function destroy() {
        if (instance) {
          instance.destroy();
          instance = null;
          document.getElementById('instanceStatus').textContent = 'Destroyed';
        }
      }

      function trigger() {
        if (!instance) return alert('Instance not initialized!');
        const id = document.getElementById('testId').value.trim();
        const value = parseInt(document.getElementById('testValue').value, 10);
        const limitInput = document.getElementById('testLimit').value.trim();
        const limit = limitInput !== '' ? parseInt(limitInput, 10) : null;

        if (!id) return alert('Enter an ID');
        if (!Number.isFinite(value)) return alert('Invalid value');

        if (!data[id]) {
          const wrapper = document.createElement('div');
          wrapper.id = `wrap-${id}`;
          wrapper.innerHTML = `
          <div class="row">
            <span><strong>${id}</strong></span>
            <div class="bar-container">
              <div class="bar" id="bar-${id}" style="width:0%"></div>
            </div>
            <span id="label-${id}">0</span>
          </div>
        `;
          document.getElementById('visualizer').appendChild(wrapper);
          data[id] = 0;
        }

        const start = performance.now();
        instance.set(
          id,
          () => {
            const delay = performance.now() - start;
            data[id]++;
            document.getElementById(`label-${id}`).textContent = `${delay.toFixed(0)}ms`;
            const bar = document.getElementById(`bar-${id}`);
            const width = Math.min(100, delay / 10);
            bar.style.width = `${width}%`;
          },
          value,
          limit,
        );
      }

      async function pollDemo() {
        if (!instance) return alert('Init instance first.');
        let counter = 0;
        const target = document.getElementById('pollResult');
        target.textContent = 'Polling...';
        setTimeout(() => (counter = 5), 3000);
        await instance.waitForTrue(() => counter === 5);
        target.textContent = 'âœ… Condition met (counter = 5)';
      }

      window.init = init;
      window.destroy = destroy;
      window.trigger = trigger;
      window.pollDemo = pollDemo;
    </script>
  </body>
</html>
