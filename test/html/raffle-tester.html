<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TinyAdvancedRaffle — Tester</title>
    <style>
      /* ---------- professional, clean UI ---------- */
      :root {
        --bg: #0f1720;
        --panel: #0b1220;
        --muted: #98a0b3;
        --accent: #6ee7b7;
        --accent-2: #60a5fa;
        --glass: rgba(255, 255, 255, 0.03);
        --glass-2: rgba(255, 255, 255, 0.02);
        --card-radius: 12px;
        --mono: 'Segoe UI Mono', 'Roboto Mono', monospace;
        font-family:
          Inter,
          ui-sans-serif,
          system-ui,
          -apple-system,
          'Segoe UI',
          Roboto,
          'Helvetica Neue',
          Arial;
        color: #e6eef8;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: linear-gradient(180deg, #071022 0%, #071728 60%);
        -webkit-font-smoothing: antialiased;
      }
      .app {
        max-width: 1300px;
        margin: 28px auto;
        padding: 24px;
        border-radius: 16px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
        box-shadow:
          0 8px 40px rgba(2, 6, 23, 0.6),
          inset 0 1px 0 rgba(255, 255, 255, 0.02);
        display: grid;
        grid-template-columns: 420px 1fr;
        gap: 20px;
      }

      /* left column: controls */
      .panel {
        background: var(--glass);
        border-radius: var(--card-radius);
        padding: 16px;
        box-shadow: 0 6px 20px rgba(3, 8, 20, 0.6);
        overflow: auto;
        max-height: 80vh;
      }
      .panel h2 {
        margin: 6px 0 12px 0;
        font-size: 18px;
        letter-spacing: 0.2px;
      }
      label {
        display: block;
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 6px;
      }
      input[type='text'],
      input[type='number'],
      select,
      textarea {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.04);
        background: transparent;
        color: inherit;
        outline: none;
        font-size: 13px;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .btn {
        background: linear-gradient(180deg, var(--accent), #2ad08b);
        color: #022;
        border: 0;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(46, 201, 157, 0.12);
      }
      .btn.secondary {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.06);
        color: var(--muted);
        box-shadow: none;
      }
      .muted {
        color: var(--muted);
        font-size: 13px;
      }
      .small {
        font-size: 12px;
        padding: 6px 8px;
        border-radius: 6px;
      }
      .items-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
      }
      .items-table th,
      .items-table td {
        padding: 8px 6px;
        text-align: left;
        font-size: 13px;
        border-bottom: 1px dashed rgba(255, 255, 255, 0.03);
      }
      .tag {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        background: var(--glass-2);
        color: var(--muted);
        margin-right: 6px;
      }
      .controls-row {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }

      /* right column: visualization */
      .canvas-panel {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
        border-radius: var(--card-radius);
        padding: 18px;
        min-height: 70vh;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .chart {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.012), rgba(255, 255, 255, 0.01));
        border-radius: 10px;
        padding: 14px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02);
        min-height: 240px;
      }
      .history {
        background: var(--glass-2);
        padding: 12px;
        border-radius: 10px;
        max-height: 220px;
        overflow: auto;
      }
      .history-item {
        padding: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .bar {
        height: 20px;
        border-radius: 6px;
        background: linear-gradient(90deg, rgba(96, 165, 250, 0.18), rgba(110, 231, 183, 0.14));
        margin-top: 6px;
      }

      footer {
        text-align: center;
        color: var(--muted);
        font-size: 13px;
        margin-top: 12px;
      }
      .flex {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      /* responsive */
      @media (max-width: 1000px) {
        .app {
          grid-template-columns: 1fr;
          padding: 12px;
        }
        .panel {
          max-height: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="app" role="application" aria-label="TinyAdvancedRaffle tester UI">
      <!-- LEFT: Controls -->
      <section class="panel" id="controls">
        <h2>TinyAdvancedRaffle — Controls</h2>

        <div>
          <label>Add item</label>
          <div class="row" style="gap: 6px">
            <input id="newItemId" type="text" placeholder="id (unique)" />
            <input id="newItemLabel" type="text" placeholder="label" />
          </div>
          <div class="row" style="margin-top: 8px">
            <input id="newItemWeight" type="number" min="0" step="any" placeholder="weight (1)" />
            <input id="newItemGroups" type="text" placeholder="groups (comma separated)" />
            <button id="btnAddItem" class="btn">Add</button>
          </div>

          <table class="items-table" id="itemsTable" aria-live="polite" style="margin-top: 10px">
            <thead>
              <tr>
                <th>id</th>
                <th>label</th>
                <th>weight</th>
                <th>groups</th>
                <th>pity</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <hr style="border: none; height: 12px" />

        <div>
          <h3 style="margin: 6px 0">Modifiers & Rules</h3>
          <label>Temporary modifier (applies for N draws)</label>
          <div class="row">
            <input id="tmpTarget" type="text" placeholder="target item id or group: group:rare" />
            <input id="tmpDelta" type="number" step="any" placeholder="delta e.g. 5" />
            <input id="tmpUses" type="number" min="1" placeholder="uses (1)" />
            <button id="btnAddTmp" class="btn small">Add temp</button>
          </div>
          <div style="margin-top: 8px">
            <label>Global modifier editor (JS)</label>
            <textarea
              id="globalModifierCode"
              rows="5"
              placeholder="// function(weightsMap, context) { /* return Map(id => delta) */ }"
            ></textarea>
            <div class="row" style="margin-top: 6px">
              <button id="btnAddGlobal" class="btn small">Register global modifier</button>
              <button id="btnClearGlobal" class="btn secondary small">Clear globals</button>
            </div>
            <div class="muted" style="margin-top: 6px">
              Global modifier must return a Map or an object keyed by id with numeric deltas. Use
              with caution — code runs inside the page.
            </div>
          </div>
        </div>

        <hr style="border: none; height: 12px" />

        <div>
          <h3 style="margin: 6px 0">Draws & Simulations</h3>
          <div class="row" style="align-items: center">
            <label style="min-width: 84px">Seed (opt.)</label>
            <input id="seedInput" type="number" placeholder="e.g. 12345" />
          </div>
          <div class="row" style="margin-top: 8px">
            <input id="drawCount" type="number" min="1" value="1" style="width: 100px" />
            <label style="min-width: 120px">count</label>
            <label class="small"
              ><input id="withReplacement" type="checkbox" checked /> withReplacement</label
            >
            <label class="small"><input id="ensureUnique" type="checkbox" /> ensureUnique</label>
          </div>
          <div class="controls-row" style="margin-top: 10px">
            <button id="btnDraw" class="btn">Draw</button>
            <button id="btnSimulate" class="btn secondary">Simulate 1000</button>
            <button id="btnClearHistory" class="btn secondary">Clear history</button>
          </div>
        </div>

        <hr style="border: none; height: 12px" />

        <div>
          <h3 style="margin: 6px 0">Quick helpers</h3>
          <div class="row">
            <button id="btnPopulateExample" class="btn small">Populate example 12 items</button>
            <button id="btnReset" class="btn secondary small">Reset engine</button>
          </div>
          <div class="muted" style="margin-top: 8px">
            Tip: Use the example to quickly test pity, groups and modifiers.
          </div>
        </div>

        <hr style="border: none; height: 12px" />

        <div>
          <label>Import / Export configuration (JSON)</label>
          <div class="row">
            <textarea
              id="jsonConfig"
              rows="4"
              placeholder="Paste TinyAdvancedRaffle export JSON here"
            ></textarea>
          </div>
          <div class="controls-row" style="margin-top: 8px">
            <button id="btnLoadJson" class="btn small">Load JSON</button>
            <button id="btnExportJson" class="btn secondary small">Export JSON</button>
          </div>
        </div>

        <footer>Tester UI • Designed for TinyAdvancedRaffle — edit as needed</footer>
      </section>

      <!-- RIGHT: visualization -->
      <section class="canvas-panel" id="viewer">
        <div style="display: flex; justify-content: space-between; align-items: center">
          <div>
            <h2 style="margin: 0">Distribution & History</h2>
            <div class="muted">Real-time distribution after current configuration</div>
          </div>
          <div class="flex">
            <div class="muted" id="summary">items: 0 • normalization: relative</div>
          </div>
        </div>

        <div class="chart" id="distributionChart" aria-hidden="false">
          <!-- svg bars will be inserted here -->
        </div>

        <div style="display: flex; gap: 12px">
          <div style="flex: 1">
            <h3 style="margin: 6px 0">History</h3>
            <div class="history" id="historyList" role="log" aria-live="polite"></div>
          </div>
          <div style="width: 320px">
            <h3 style="margin: 6px 0">Stats</h3>
            <div id="statsCards" style="display: grid; gap: 8px">
              <div style="padding: 12px; background: var(--glass-2); border-radius: 8px">
                <div class="muted">Total draws run</div>
                <div id="statTotal" style="font-weight: 700; font-size: 18px">0</div>
              </div>
              <div style="padding: 12px; background: var(--glass-2); border-radius: 8px">
                <div class="muted">Unique items</div>
                <div id="statUnique" style="font-weight: 700; font-size: 18px">0</div>
              </div>
              <div style="padding: 12px; background: var(--glass-2); border-radius: 8px">
                <div class="muted">Top pick</div>
                <div id="statTop" style="font-weight: 700; font-size: 14px">—</div>
              </div>
            </div>
          </div>
        </div>

        <footer style="margin-top: auto">
          You provide <code>TinyAdvancedRaffle.js</code> (ES module). This UI imports it at runtime.
        </footer>
      </section>
    </div>

    <script type="module">
      // -------------------------------------
      // Tester wiring for TinyAdvancedRaffle
      // - Assumes ./TinyAdvancedRaffle.js exports default class TinyAdvancedRaffle
      // - All code in English; safe to edit; extensive comments.
      // -------------------------------------
      import { TinyAdvancedRaffle } from './src/v1/libs/TinyAdvancedRaffle.mjs';

      // create engine
      const engine = new TinyAdvancedRaffle({ seed: null, normalization: 'relative' });
      window.tinyEngine = engine;

      // UI references
      const itemsTbody = document.querySelector('#itemsTable tbody');
      const btnAddItem = document.getElementById('btnAddItem');
      const newItemId = document.getElementById('newItemId');
      const newItemLabel = document.getElementById('newItemLabel');
      const newItemWeight = document.getElementById('newItemWeight');
      const newItemGroups = document.getElementById('newItemGroups');
      const btnDraw = document.getElementById('btnDraw');
      const btnSimulate = document.getElementById('btnSimulate');
      const historyList = document.getElementById('historyList');
      const distributionChart = document.getElementById('distributionChart');
      const statTotal = document.getElementById('statTotal');
      const statUnique = document.getElementById('statUnique');
      const statTop = document.getElementById('statTop');
      const summary = document.getElementById('summary');
      const btnPopulateExample = document.getElementById('btnPopulateExample');
      const btnReset = document.getElementById('btnReset');
      const btnExportJson = document.getElementById('btnExportJson');
      const btnLoadJson = document.getElementById('btnLoadJson');
      const jsonConfig = document.getElementById('jsonConfig');
      const seedInput = document.getElementById('seedInput');
      const drawCount = document.getElementById('drawCount');
      const withReplacement = document.getElementById('withReplacement');
      const ensureUnique = document.getElementById('ensureUnique');
      const btnClearHistory = document.getElementById('btnClearHistory');

      const tmpTarget = document.getElementById('tmpTarget');
      const tmpDelta = document.getElementById('tmpDelta');
      const tmpUses = document.getElementById('tmpUses');
      const btnAddTmp = document.getElementById('btnAddTmp');

      const globalModifierCode = document.getElementById('globalModifierCode');
      const btnAddGlobal = document.getElementById('btnAddGlobal');
      const btnClearGlobal = document.getElementById('btnClearGlobal');

      // local state for history & frequencies
      let history = [];
      const freq = new Map();

      // helper: render items table from engine.items
      function renderItemsTable() {
        itemsTbody.innerHTML = '';
        const items = engine.listItems();
        for (const it of items) {
          const tr = document.createElement('tr');

          const tdId = document.createElement('td');
          tdId.textContent = it.id;
          const tdLabel = document.createElement('td');
          tdLabel.textContent = it.label;
          const tdWeight = document.createElement('td');
          const inputW = document.createElement('input');
          inputW.type = 'number';
          inputW.value = it.baseWeight;
          inputW.min = 0;
          inputW.step = 'any';
          inputW.style.width = '100px';
          inputW.addEventListener('change', () => {
            engine.setBaseWeight(it.id, Number(inputW.value));
            updateDistribution();
          });
          tdWeight.appendChild(inputW);

          const tdGroups = document.createElement('td');
          tdGroups.textContent = Array.from(it.groups || []).join(', ');

          const tdPity = document.createElement('td');
          const pityBtn = document.createElement('button');
          pityBtn.className = 'small btn secondary';
          pityBtn.textContent = 'configure';
          pityBtn.addEventListener('click', () => openPityEditor(it));
          tdPity.appendChild(pityBtn);

          const tdActions = document.createElement('td');
          const delBtn = document.createElement('button');
          delBtn.className = 'small btn secondary';
          delBtn.textContent = 'remove';
          delBtn.addEventListener('click', () => {
            engine.removeItem(it.id);
            renderItemsTable();
            updateDistribution();
          });
          tdActions.appendChild(delBtn);

          tr.append(tdId, tdLabel, tdWeight, tdGroups, tdPity, tdActions);
          itemsTbody.appendChild(tr);
        }
        updateSummary();
      }

      function updateSummary() {
        summary.textContent = `items: ${engine.size} • normalization: ${engine.normalization}`;
      }

      // open pity editor (simple prompt-based editor for now)
      function openPityEditor(item) {
        const existing = engine.pitySystems.get(item.id);
        const threshold = existing ? existing.threshold : 0;
        const increment = existing ? existing.increment : 0;
        const cap = existing ? existing.cap : Infinity;
        const t = prompt(
          `Configure pity for "${item.id}"\nthreshold (draws without item):`,
          threshold || 0,
        );
        if (t === null) return;
        const inc = prompt('increment (added weight each step):', increment || 0);
        if (inc === null) return;
        const c = prompt('cap (max added weight) (empty = no cap):', isFinite(cap) ? cap : '');
        if (c === null) return;
        const cfg = {
          threshold: Number(t),
          increment: Number(inc),
          cap: c === '' ? Infinity : Number(c),
        };
        if (cfg.threshold > 0 && cfg.increment > 0) {
          engine.configurePity(item.id, cfg);
          alert('Pity configured — acceptable default for testing.');
        } else {
          alert('Invalid pity configuration (threshold and increment must be > 0).');
        }
      }

      // add item button
      btnAddItem.addEventListener('click', () => {
        const id = (newItemId.value || '').trim();
        if (!id) {
          alert('id is required');
          return;
        }
        const label = (newItemLabel.value || id).trim();
        const w = newItemWeight.value !== '' ? Number(newItemWeight.value) : 1;
        const groups = (newItemGroups.value || '')
          .split(',')
          .map((s) => s.trim())
          .filter(Boolean);
        engine.addItem(id, { weight: w, label, meta: {}, groups });
        newItemId.value = '';
        newItemLabel.value = '';
        newItemWeight.value = '';
        newItemGroups.value = '';
        renderItemsTable();
        updateDistribution();
      });

      // add temporary modifier
      btnAddTmp.addEventListener('click', () => {
        const target = (tmpTarget.value || '').trim();
        const delta = Number(tmpDelta.value) || 0;
        const uses = Number(tmpUses.value) || 1;
        if (!target || !delta) {
          alert('Provide target (item id or "group:NAME") and non-zero delta');
          return;
        }

        // build modifier function
        const fn = (weights) => {
          const out = new Map();
          if (target.startsWith('group:')) {
            const groupName = target.slice(6);
            for (const [id] of weights) {
              const it = engine.getItem(id);
              if (it && it.groups && it.groups.has(groupName)) out.set(id, delta);
            }
          } else {
            if (weights.has(target)) out.set(target, delta);
          }
          return out;
        };
        engine.addTemporaryModifier(fn, uses);
        tmpTarget.value = '';
        tmpDelta.value = '';
        tmpUses.value = '';
        alert('Temporary modifier added (applies to next draws).');
        updateDistribution();
      });

      // global modifier editor
      btnAddGlobal.addEventListener('click', () => {
        const code = globalModifierCode.value.trim();
        if (!code) {
          alert('Paste a function body or an expression that returns a Map/object');
          return;
        }
        // We'll wrap user code in a function safely (no sandbox — user code executes here).
        // The expected signature: (weightsMap, context) => Map or Object
        let fn;
        try {
          // attempt to create a function from code. We accept either a function expression or body that returns something.
          if (code.startsWith('function') || code.includes('=>')) {
            // user likely pasted full function
            // eslint-disable-next-line no-eval
            fn = eval('(' + code + ')');
          } else {
            // wrap into function body
            // eslint-disable-next-line no-eval
            fn = eval('(function(weightsMap, context){' + code + '})');
          }
          engine.addGlobalModifier(fn);
          alert('Global modifier registered.');
          globalModifierCode.value = '';
          updateDistribution();
        } catch (err) {
          console.error(err);
          alert('Error creating modifier: ' + err.message);
        }
      });

      btnClearGlobal.addEventListener('click', () => {
        engine.globalModifiers = [];
        alert('Global modifiers cleared.');
        updateDistribution();
      });

      // draw / simulate
      btnDraw.addEventListener('click', async () => {
        const count = Math.max(1, Number(drawCount.value) || 1);
        const seed = seedInput.value !== '' ? Number(seedInput.value) : null;
        if (seed !== null) engine.seed = seed;

        const opts = { previousDraws: [...history], metadata: {} };
        const results = engine.drawMany(count, {
          withReplacement: withReplacement.checked,
          ensureUnique: ensureUnique.checked,
          previousDraws: opts.previousDraws,
        });
        handleResults(results);
        renderItemsTable();
        updateDistribution();
      });

      btnSimulate.addEventListener('click', () => {
        const n = 1000;
        const seed = seedInput.value !== '' ? Number(seedInput.value) : null;
        if (seed !== null) engine.seed = seed;
        // simulation uses engine.simulate which snapshots state
        const result = engine.simulate(n, {});
        // show top results in an alert + update a quick chart
        const freqObj = result.freq;
        console.log('simulate freq', freqObj);
        // convert to readable
        const items = Object.keys(freqObj)
          .map((k) => ({ id: k, count: freqObj[k] }))
          .sort((a, b) => b.count - a.count);
        if (items.length === 0) {
          alert('No items available for simulation');
          return;
        }
        const top = items
          .slice(0, 6)
          .map((it) => `${it.id}: ${it.count}`)
          .join('\n');
        alert(`Simulation (${n}) results — top items:\n` + top);
        // for convenience, update distribution/chart after simulation too
        updateDistribution();
      });

      // export/import json
      btnExportJson.addEventListener('click', () => {
        try {
          jsonConfig.value = engine.exportToJson();
          alert('Config exported to textarea below — copy and save.');
        } catch (err) {
          alert('Error exporting JSON: ' + err.message);
        }
      });

      btnLoadJson.addEventListener('click', () => {
        const txt = jsonConfig.value.trim();
        if (!txt) {
          alert('Paste JSON first');
          return;
        }
        try {
          engine.loadFromJson(txt);
          renderItemsTable();
          updateDistribution();
          alert('Configuration loaded.');
        } catch (err) {
          console.error(err);
          alert('Error loading JSON: ' + err.message);
        }
      });

      // populate example
      btnPopulateExample.addEventListener('click', () => {
        // reset
        engine.clearList();
        engine.clearPities();
        engine.temporaryModifiers = [];
        // provide 12 example items, 2 groups: rare & legendary
        for (let i = 1; i <= 12; i++) {
          const id = 'item' + i;
          const g = i >= 10 ? (i >= 12 ? ['legendary'] : ['rare']) : [];
          engine.addItem(id, {
            weight: i <= 6 ? 10 : i <= 9 ? 4 : 1,
            label: `Item ${i}`,
            groups: g,
          });
        }
        // configure pity on legendary
        engine.configurePity('item12', { threshold: 20, increment: 2, cap: 40 });
        renderItemsTable();
        updateDistribution();
        alert('Example populated (12 items). Try simulate and temporary modifiers.');
      });

      btnReset.addEventListener('click', () => {
        location.reload();
      });

      // history & display
      function handleResults(results) {
        if (!Array.isArray(results)) results = results ? [results] : [];
        for (const r of results) {
          if (!r) continue;
          history.push(r);
          // update frequency
          freq.set(r.id, (freq.get(r.id) || 0) + 1);
          const el = document.createElement('div');
          el.className = 'history-item';
          el.innerHTML = `<div><strong>${r.id}</strong> <span class="muted">(${(r.prob * 100).toFixed(2)}%)</span></div><div class="muted">${r.label}</div>`;
          historyList.prepend(el);
        }
        updateStats();
      }

      btnClearHistory.addEventListener('click', () => {
        history = [];
        freq.clear();
        historyList.innerHTML = '';
        updateStats();
      });

      function updateStats() {
        statTotal.textContent = String(history.length || 0);
        statUnique.textContent = String(freq.size);
        // top pick
        let topPair = null;
        for (const [k, v] of freq) {
          if (!topPair || v > topPair[1]) topPair = [k, v];
        }
        statTop.textContent = topPair ? `${topPair[0]} (${topPair[1]})` : '—';
      }

      // distribution chart: simple SVG horizontal bars
      function updateDistribution() {
        const weights = engine.computeEffectiveWeights({ previousDraws: history, metadata: {} });
        const dist = engine._weightsToDistribution(weights);
        // clear
        distributionChart.innerHTML = '';
        if (!dist.length) {
          distributionChart.innerHTML = '<div class="muted">No items available</div>';
          updateSummary();
          return;
        }
        // build a simple list with bars
        const container = document.createElement('div');
        const maxP = Math.max(...dist.map((d) => d.p));
        for (const d of dist.sort((a, b) => b.p - a.p)) {
          const row = document.createElement('div');
          const titleRow = document.createElement('div');
          titleRow.style.display = 'flex';
          titleRow.style.justifyContent = 'space-between';
          titleRow.innerHTML = `<div><strong>${d.id}</strong> <span class="muted">${d.weight.toFixed(3)}</span></div><div class="muted">${(d.p * 100).toFixed(3)}%</div>`;
          const barWrap = document.createElement('div');
          barWrap.style.marginTop = '6px';
          const bar = document.createElement('div');
          bar.className = 'bar';
          const widthPercent = (d.p / maxP) * 100;
          bar.style.width = Math.max(6, widthPercent) + '%';
          bar.title = `${(d.p * 100).toFixed(4)}%`;
          barWrap.appendChild(bar);
          row.appendChild(titleRow);
          row.appendChild(barWrap);
          row.style.marginBottom = '12px';
          container.appendChild(row);
        }
        distributionChart.appendChild(container);

        // update summary
        updateSummary();
      }

      // initial render
      renderItemsTable();
      updateDistribution();

      // small safety: listen to engine 'draw' events if provided
      engine.on('draw', (payload) => {
        // optional: if engine emits draw, we mirror it into history
        // but to avoid double counting, only accept if not already in history's last element
        const last = history[history.length - 1];
        if (!last || last.id !== payload.id) {
          // do not auto-add — leave draws triggered by UI only
        }
      });

      // keyboard shortucts
      window.addEventListener('keydown', (ev) => {
        if ((ev.ctrlKey || ev.metaKey) && ev.key === 'd') {
          ev.preventDefault();
          btnDraw.click();
        }
        if ((ev.ctrlKey || ev.metaKey) && ev.key === 's') {
          ev.preventDefault();
          btnSimulate.click();
        }
      });

      // expose engine for debugging via window
      window.__AdvancedRaffleEngine = engine;
      window.__RaffleUI = { updateDistribution, renderItemsTable, handleResults };

      // developer note: if your TinyAdvancedRaffle API differs in method names, adapt the small glue code above.
    </script>
  </body>
</html>
