<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LLM VRAM Estimator — Full Quantization Matrix</title>
    <style>
      /* ---------- Base ---------- */
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Ubuntu,
          Cantarell,
          'Helvetica Neue',
          Arial,
          'Noto Sans',
          'Apple Color Emoji',
          'Segoe UI Emoji',
          'Segoe UI Symbol';
        line-height: 1.6;
        background: #0b0d10;
        color: #e6ebf0;
      }
      a {
        color: #9ecbff;
      }

      /* ---------- Layout ---------- */
      .container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 24px;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 20;
        background: linear-gradient(180deg, rgba(11, 13, 16, 0.95) 85%, rgba(11, 13, 16, 0));
        backdrop-filter: blur(6px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 12px 0 8px 0;
        margin-bottom: 8px;
      }
      h1 {
        margin: 0;
        font-size: 1.6rem;
        letter-spacing: 0.2px;
      }
      .subtitle {
        margin: 2px 0 0 0;
        color: #b9c6d3;
        font-size: 0.95rem;
      }

      .row {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 12px;
        align-items: center;
        margin: 10px 0;
      }

      .grid {
        display: grid;
        gap: 16px;
      }
      @media (min-width: 960px) {
        .grid-2 {
          grid-template-columns: 1fr 1fr;
        }
        .grid-3 {
          grid-template-columns: 1fr 1fr 1fr;
        }
      }

      /* ---------- Cards ---------- */
      .card {
        background: #0f1318;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 18px;
        box-shadow:
          0 0 0 1px rgba(255, 255, 255, 0.02) inset,
          0 8px 30px rgba(0, 0, 0, 0.35);
      }
      .card h2 {
        margin: 0 0 10px 0;
        font-size: 1.2rem;
        color: #d9e2ec;
      }
      .card h3 {
        margin: 0 0 8px 0;
        font-size: 1.05rem;
        color: #d9e2ec;
      }

      /* ---------- Controls ---------- */
      label {
        color: #cbd5e1;
        font-weight: 600;
      }
      input[type='number'],
      input[type='text'],
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: #0b0f14;
        color: #e6ebf0;
        outline: none;
      }
      input[type='checkbox'] {
        transform: scale(1.2);
      }
      .inline {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }
      .btn {
        appearance: none;
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: #11161d;
        color: #e6ebf0;
        cursor: pointer;
        font-weight: 700;
        transition:
          transform 0.04s ease,
          background 0.2s ease;
      }
      .btn:hover {
        background: #151c25;
      }
      .btn:active {
        transform: translateY(1px);
      }
      .badge {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: #0b0f14;
        font-size: 0.85rem;
        color: #d3deea;
      }
      .hint {
        color: #9fb1c3;
        font-size: 0.92rem;
      }

      /* ---------- Tables ---------- */
      .table-wrap {
        overflow: auto;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 900px;
        background: #0b0f14;
      }
      th,
      td {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        white-space: nowrap;
        text-align: right;
      }
      th:first-child,
      td:first-child {
        text-align: left;
        position: sticky;
        left: 0;
        background: inherit;
      }
      thead th {
        position: sticky;
        top: 0;
        background: #0f1318;
        z-index: 5;
      }
      tbody tr:hover td {
        background: rgba(255, 255, 255, 0.03);
      }

      /* ---------- Status ---------- */
      .status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        font-weight: 800;
      }
      .ok {
        color: #c3f0c8;
        border-color: rgba(99, 255, 153, 0.25);
        background: rgba(99, 255, 153, 0.06);
      }
      .warn {
        color: #ffe3a3;
        border-color: rgba(255, 217, 119, 0.25);
        background: rgba(255, 217, 119, 0.06);
      }
      .fail {
        color: #ffc0c0;
        border-color: rgba(255, 99, 99, 0.25);
        background: rgba(255, 99, 99, 0.06);
      }

      /* ---------- Scrollbars ---------- */
      :root {
        --scrollbarBG: #0b0f14;
        --thumbBG: #2b3542;
      }
      * {
        scrollbar-width: thin;
        scrollbar-color: var(--thumbBG) var(--scrollbarBG);
      }
      *::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      *::-webkit-scrollbar-track {
        background: var(--scrollbarBG);
        border-radius: 10px;
      }
      *::-webkit-scrollbar-thumb {
        background-color: var(--thumbBG);
        border-radius: 10px;
        border: 2px solid var(--scrollbarBG);
      }

      footer {
        margin: 28px 0 40px 0;
        color: #95a3b3;
        font-size: 0.9rem;
      }
      code {
        background: #0f1318;
        padding: 2px 6px;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="inline" style="justify-content: space-between">
          <div>
            <h1>LLM VRAM Estimator — Full Quantization Matrix</h1>
            <p class="subtitle">
              Ferramenta avançada para estimar VRAM de <b>qualquer</b> modelo de texto, incluindo
              FP*, INT*, Q2..Q8, Q*_K_*, GPTQ, AWQ, NF4 e custom.
            </p>
          </div>
          <div class="inline">
            <span class="badge">No deps</span>
            <span class="badge">Editable presets</span>
          </div>
        </div>
      </header>

      <section class="card">
        <h2>Calculator</h2>
        <div class="grid grid-3">
          <div class="card">
            <div class="row">
              <label for="modelB">Model size (B params)</label>
              <input id="modelB" type="number" min="0.1" step="0.1" value="7" />
            </div>
            <div class="row">
              <label for="precision">Precision / Quantization</label>
              <select id="precision"></select>
            </div>
            <div class="row">
              <label for="gpuVram">Your GPU VRAM (GB)</label>
              <input id="gpuVram" type="number" min="1" step="0.5" value="12" />
            </div>
            <div class="row">
              <label for="overhead">Runtime overhead (%)</label>
              <input id="overhead" type="number" min="0" max="100" step="1" value="15" />
            </div>
          </div>

          <div class="card">
            <div class="row">
              <label for="contextLen">Context length (tokens)</label>
              <input id="contextLen" type="number" min="128" step="128" value="4096" />
            </div>
            <div class="row">
              <label for="batchSize">Batch size</label>
              <input id="batchSize" type="number" min="1" step="1" value="1" />
            </div>
            <div class="row">
              <label for="kvPerToken">KV cache per token (MB)</label>
              <input id="kvPerToken" type="number" min="0.05" step="0.05" value="0.50" />
            </div>
            <div class="row">
              <label for="kvScaling">KV scaling vs 7B</label>
              <input id="kvScaling" type="number" min="0.05" step="0.05" value="1.0" />
            </div>
            <p class="hint">
              Regra base: 7B FP16 ≈ <b>0.5 MB/token</b>. Para outros tamanhos, use KV scaling ≈
              (model_B / 7).
            </p>
          </div>

          <div class="card">
            <h3 style="margin-top: 0">Actions</h3>
            <div class="inline">
              <button class="btn" id="calcBtn">Calculate</button>
              <button class="btn" id="preset3060">Preset RTX 3060 12GB</button>
              <button class="btn" id="preset4090">Preset RTX 4090 24GB</button>
              <button class="btn" id="preset70B">Preset 70B @ Q4_K_M</button>
            </div>
            <div class="inline" style="margin-top: 8px">
              <button class="btn" id="exportBtn">Export presets (JSON)</button>
              <input type="file" id="importFile" accept="application/json" style="display: none" />
              <button class="btn" id="importBtn">Import presets</button>
            </div>
            <p class="hint">Você pode exportar/importar seus próprios presets de quantização.</p>
          </div>
        </div>

        <div class="grid grid-2" style="margin-top: 12px">
          <div class="card">
            <h3 style="margin-top: 0">Results</h3>
            <div id="resultBlocks" class="grid"></div>
          </div>
          <div class="card">
            <h3 style="margin-top: 0">Fit Status</h3>
            <div id="fitStatus" class="status">—</div>
            <p class="hint" style="margin-top: 10px">
              Notas: estimativa conservadora. Some KV-cache + overhead. Valores reais variam por
              framework (paged attention, loaders, fused kernels, offloading).
            </p>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Presets de Quantização (editáveis)</h2>
        <div class="grid grid-2">
          <div class="card">
            <h3 style="margin-top: 0">Adicionar / Atualizar</h3>
            <div class="row">
              <label for="qName">Name</label>
              <input id="qName" type="text" placeholder="ex: Q4_K_M" />
            </div>
            <div class="row">
              <label for="qGBPerB">GB per 1B params</label>
              <input id="qGBPerB" type="number" min="0.05" step="0.01" placeholder="ex: 0.62" />
            </div>
            <div class="row">
              <label for="qNote">Note</label>
              <input id="qNote" type="text" placeholder="ex: GGUF block scales overhead" />
            </div>
            <div class="inline">
              <button class="btn" id="addUpdatePreset">Add / Update</button>
              <button class="btn" id="deletePreset">Delete</button>
            </div>
            <p class="hint">
              Dica: GB/1B = bytes por parâmetro ÷ (1024^3). Ex.: 4-bit ideal ≈ 0.5 GB/1B. Overheads
              de bloco (scales/zeros) elevam o valor.
            </p>
          </div>
          <div class="card">
            <h3 style="margin-top: 0">Lista atual</h3>
            <div class="table-wrap" style="max-height: 340px">
              <table id="presetTable">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>GB / 1B</th>
                    <th>Note</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Tabela de Referência — VRAM por tamanho (GB)</h2>
        <div class="table-wrap">
          <table id="refTable">
            <thead>
              <tr>
                <th>Precision</th>
                <th>1B</th>
                <th>3B</th>
                <th>7B</th>
                <th>13B</th>
                <th>33B</th>
                <th>70B</th>
                <th>110B</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="hint">
          Tabela mostra apenas o <i>peso do modelo</i>. Para uso total, inclua KV-cache + overhead.
        </p>
      </section>

      <section class="card">
        <h2>Regras & Notas</h2>
        <ul>
          <li>
            <b>Regra base por 1B:</b> FP32 ~ 4.00 · FP16/BF16 ~ 2.00 · FP8/INT8 ~ 1.00 · INT6 ~ 0.75
            · INT5 ~ 0.63 · INT4 ~ 0.50 · INT3 ~ 0.38 · INT2 ~ 0.25 (GB/1B).
          </li>
          <li>
            <b>Q-variants (aprox.):</b> Q2_K ~ 0.34 · Q3_K_M ~ 0.39 · Q3_K_S ~ 0.44 · Q4_0 ~ 0.54 ·
            Q4_1 ~ 0.68 · Q4_K_M ~ 0.62 · Q4_K_S ~ 0.67 · Q5_0 ~ 0.80 · Q5_1 ~ 0.83 · Q5_K_M ~ 0.79
            · Q5_K_S ~ 0.82 · Q6_K ~ 0.98 · Q8_0 ~ 1.00
          </li>
          <li>
            <b>KV-cache:</b> ~0.5 MB/token @ 7B FP16 (padrão). Escale por <i>batch</i> e tamanho do
            modelo.
          </li>
          <li>
            <b>Overhead:</b> reserve 10–20% extra. Frameworks modernos podem reduzir com técnicas
            como <i>paged attention</i>.
          </li>
          <li>
            <b>Offloading:</b> parte do modelo/KV pode ir para RAM quando VRAM não couber (impacto
            em performance).
          </li>
        </ul>
      </section>

      <footer>
        Scripts e labels em <b>English</b>. Números são estimativas para <b>inferência</b>. Ajuste
        presets conforme seu framework (GGUF, GPTQ, AWQ, bitsandbytes, ExLlama, etc.).
      </footer>
    </div>

    <script>
      // =================== PRESETS ===================
      /** Default presets with broad coverage. Values are GB per 1B params. */
      const DEFAULT_PRESETS = [
        // Floats
        { name: 'FP32', gbPerB: 4.0, note: '32-bit float storage' },
        { name: 'BF16', gbPerB: 2.0, note: '16-bit bfloat storage' },
        { name: 'FP16', gbPerB: 2.0, note: '16-bit float storage' },
        { name: 'FP8', gbPerB: 1.0, note: '8-bit float (approx, storage parity with INT8)' },

        // Plain INT
        { name: 'INT8', gbPerB: 1.0, note: '8-bit integer' },
        { name: 'INT6', gbPerB: 0.75, note: '6-bit integer (approx)' },
        { name: 'INT5', gbPerB: 0.625, note: '5-bit integer (approx)' },
        { name: 'INT4', gbPerB: 0.5, note: '4-bit integer (ideal)' },
        { name: 'INT3', gbPerB: 0.375, note: '3-bit integer (approx)' },
        { name: 'INT2', gbPerB: 0.25, note: '2-bit integer (approx)' },

        // GGUF/GGML families
        { name: 'Q2_K', gbPerB: 0.34, note: 'GGUF block 2-bit (approx overhead)' },
        { name: 'Q3_K_M', gbPerB: 0.39, note: 'GGUF 3-bit medium' },
        { name: 'Q3_K_S', gbPerB: 0.44, note: 'GGUF 3-bit small' },
        { name: 'Q4_0', gbPerB: 0.54, note: 'GGUF 4-bit baseline' },
        { name: 'Q4_1', gbPerB: 0.68, note: 'GGUF 4-bit higher fidelity' },
        { name: 'Q4_K_M', gbPerB: 0.62, note: 'GGUF 4-bit K_M' },
        { name: 'Q4_K_S', gbPerB: 0.67, note: 'GGUF 4-bit K_S' },
        { name: 'Q5_0', gbPerB: 0.8, note: 'GGUF 5-bit baseline' },
        { name: 'Q5_1', gbPerB: 0.83, note: 'GGUF 5-bit higher fidelity' },
        { name: 'Q5_K_M', gbPerB: 0.79, note: 'GGUF 5-bit K_M' },
        { name: 'Q5_K_S', gbPerB: 0.82, note: 'GGUF 5-bit K_S' },
        { name: 'Q6_K', gbPerB: 0.98, note: 'GGUF 6-bit K' },
        { name: 'Q8_0', gbPerB: 1.0, note: 'GGUF 8-bit baseline' },

        // GPTQ / AWQ / BitsAndBytes styles (approximate storage costs)
        { name: 'GPTQ-8bit', gbPerB: 1.0, note: 'GPTQ 8-bit weights' },
        { name: 'GPTQ-6bit', gbPerB: 0.75, note: 'GPTQ 6-bit (approx)' },
        { name: 'GPTQ-5bit', gbPerB: 0.625, note: 'GPTQ 5-bit (approx)' },
        { name: 'GPTQ-4bit-g128', gbPerB: 0.56, note: 'GPTQ 4-bit, group 128 (approx overhead)' },
        { name: 'GPTQ-4bit-g64', gbPerB: 0.6, note: 'GPTQ 4-bit, group 64 (more overhead)' },
        { name: 'GPTQ-3bit', gbPerB: 0.42, note: 'GPTQ 3-bit (approx)' },
        { name: 'AWQ-4bit', gbPerB: 0.58, note: 'AWQ 4-bit (approx)' },
        { name: 'NF4-4bit', gbPerB: 0.56, note: 'BitsAndBytes NF4 (approx)' },
        { name: 'FP4-4bit', gbPerB: 0.56, note: '4-bit float family (approx)' },
      ];

      const MODEL_SIZES = [1, 3, 7, 13, 33, 70, 110];

      // State
      let presets = [];

      // =================== Helpers ===================
      const $ = (id) => document.getElementById(id);
      const fmt = (n) => Number(n).toLocaleString(undefined, { maximumFractionDigits: 2 });
      const modelGB = (b, gPerB) => b * gPerB;
      const kvGB = (mbPerTok, ctx, batch, scale) => (mbPerTok * ctx * batch * scale) / 1024;
      const withOverhead = (gb, pct) => gb * (1 + pct / 100);

      const loadPresets = () => {
        const saved = localStorage.getItem('llm-vram-presets');
        presets = saved ? JSON.parse(saved) : DEFAULT_PRESETS.slice();
      };
      const savePresets = () => localStorage.setItem('llm-vram-presets', JSON.stringify(presets));

      const rebuildPresetSelect = () => {
        const sel = $('precision');
        sel.innerHTML = '';
        presets.forEach((p) => {
          const opt = document.createElement('option');
          opt.value = p.name;
          opt.textContent = `${p.name} — ${fmt(p.gbPerB)} GB/1B`;
          sel.appendChild(opt);
        });
        const idx =
          presets.findIndex((p) => p.name === 'Q4_K_M') !== -1
            ? presets.findIndex((p) => p.name === 'Q4_K_M')
            : presets.findIndex((p) => p.name === 'FP16');
        sel.selectedIndex = idx >= 0 ? idx : 0;
      };

      const rebuildPresetTable = () => {
        const tbody = document.querySelector('#presetTable tbody');
        tbody.innerHTML = '';
        presets.forEach((p) => {
          const tr = document.createElement('tr');
          const tdN = document.createElement('td');
          tdN.textContent = p.name;
          tdN.style.textAlign = 'left';
          const tdG = document.createElement('td');
          tdG.textContent = fmt(p.gbPerB);
          const tdNote = document.createElement('td');
          tdNote.textContent = p.note || '';
          tr.appendChild(tdN);
          tr.appendChild(tdG);
          tr.appendChild(tdNote);
          tr.addEventListener('click', () => {
            $('qName').value = p.name;
            $('qGBPerB').value = p.gbPerB;
            $('qNote').value = p.note || '';
          });
          tbody.appendChild(tr);
        });
      };

      const rebuildRefTable = () => {
        const tbody = document.querySelector('#refTable tbody');
        tbody.innerHTML = '';
        presets.forEach((p) => {
          const tr = document.createElement('tr');
          const td0 = document.createElement('td');
          td0.textContent = p.name;
          td0.style.textAlign = 'left';
          tr.appendChild(td0);
          MODEL_SIZES.forEach((B) => {
            const td = document.createElement('td');
            td.textContent = fmt(modelGB(B, p.gbPerB));
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      };

      const currentPreset = () => {
        const name = $('precision').value;
        return presets.find((p) => p.name === name);
      };

      // =================== Calculator ===================
      const renderResults = ({ modelOnlyGB, kvOnlyGB, subtotalGB, totalGB }) => {
        const wrap = $('resultBlocks');
        wrap.innerHTML = '';
        const block = (title, gb) => {
          const card = document.createElement('div');
          card.className = 'card';
          const h3 = document.createElement('h3');
          h3.textContent = title;
          const p = document.createElement('p');
          p.style.fontSize = '1.15rem';
          p.style.fontWeight = '800';
          p.textContent = fmt(gb) + ' GB';
          card.appendChild(h3);
          card.appendChild(p);
          wrap.appendChild(card);
        };
        block('Model size', modelOnlyGB);
        block('KV-cache', kvOnlyGB);
        block('Subtotal (model + KV)', subtotalGB);
        block('Total with overhead', totalGB);
      };

      const renderFit = (total, gpu) => {
        const fit = $('fitStatus');
        fit.className = 'status';
        if (!(gpu > 0)) {
          fit.classList.add('warn');
          fit.textContent = 'Please set a valid GPU VRAM';
          return;
        }
        const r = total / gpu;
        if (r <= 0.9) {
          fit.classList.add('ok');
          fit.textContent = 'Fits comfortably';
        } else if (r <= 1.0) {
          fit.classList.add('warn');
          fit.textContent = 'Fits, but tight — reduce context/overhead';
        } else {
          fit.classList.add('fail');
          fit.textContent = 'Does NOT fit — consider quantization/offloading';
        }
      };

      const calculate = () => {
        const modelB = parseFloat($('modelB').value);
        const gpuGB = parseFloat($('gpuVram').value);
        const overhead = parseFloat($('overhead').value);
        const ctx = parseInt($('contextLen').value, 10);
        const batch = parseInt($('batchSize').value, 10);
        const kvMB = parseFloat($('kvPerToken').value);
        const kvScale = parseFloat($('kvScaling').value);

        const preset = currentPreset();
        const modelOnlyGB = modelGB(modelB, preset.gbPerB);
        const kvOnlyGB = kvGB(kvMB, ctx, batch, kvScale);
        const subtotalGB = modelOnlyGB + kvOnlyGB;
        const totalGB = withOverhead(subtotalGB, overhead);

        renderResults({ modelOnlyGB, kvOnlyGB, subtotalGB, totalGB });
        renderFit(totalGB, gpuGB);
      };

      // =================== CRUD Presets ===================
      $('addUpdatePreset').addEventListener('click', () => {
        const name = $('qName').value.trim();
        const gbPerB = parseFloat($('qGBPerB').value);
        const note = $('qNote').value.trim();
        if (!name || !(gbPerB > 0)) {
          alert('Please provide a valid name and GB/1B value.');
          return;
        }
        const idx = presets.findIndex((p) => p.name === name);
        if (idx >= 0) presets[idx] = { name, gbPerB, note };
        else presets.push({ name, gbPerB, note });
        savePresets();
        rebuildPresetSelect();
        rebuildPresetTable();
        rebuildRefTable();
        calculate();
        $('qName').value = '';
        $('qGBPerB').value = '';
        $('qNote').value = '';
      });

      $('deletePreset').addEventListener('click', () => {
        const name = $('qName').value.trim();
        if (!name) {
          alert('Select or type a preset name to delete.');
          return;
        }
        const idx = presets.findIndex((p) => p.name === name);
        if (idx >= 0) {
          presets.splice(idx, 1);
          savePresets();
          rebuildPresetSelect();
          rebuildRefTable();
          rebuildPresetTable();
          calculate();
        }
        $('qName').value = '';
        $('qGBPerB').value = '';
        $('qNote').value = '';
      });

      // =================== Import/Export ===================
      $('exportBtn').addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(presets, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'llm_vram_presets.json';
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 500);
      });

      $('importBtn').addEventListener('click', () => $('importFile').click());
      $('importFile').addEventListener('change', async (ev) => {
        const file = ev.target.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          if (!Array.isArray(data)) throw new Error('Invalid JSON (expected array)');
          data.forEach((x) => {
            if (!x.name || !(x.gbPerB > 0)) throw new Error('Invalid preset entry');
          });
          presets = data;
          savePresets();
          rebuildPresetSelect();
          rebuildPresetTable();
          rebuildRefTable();
          calculate();
        } catch (e) {
          alert('Failed to import: ' + e.message);
        } finally {
          ev.target.value = '';
        }
      });

      // =================== Presets/Ref/Init ===================
      const init = () => {
        const saved = localStorage.getItem('llm-vram-presets');
        presets = saved ? JSON.parse(saved) : DEFAULT_PRESETS.slice();
        rebuildPresetSelect();
        rebuildPresetTable();
        rebuildRefTable();
        calculate();

        document.querySelectorAll('input, select').forEach((el) => {
          el.addEventListener('change', calculate);
          el.addEventListener('input', calculate);
        });

        $('preset3060').addEventListener('click', () => {
          $('gpuVram').value = 12;
          $('modelB').value = 7;
          $('precision').value = 'Q4_K_M';
          $('contextLen').value = 4096;
          $('kvPerToken').value = 0.5;
          $('overhead').value = 15;
          $('batchSize').value = 1;
          $('kvScaling').value = (7 / 7).toFixed(1);
          calculate();
        });
        $('preset4090').addEventListener('click', () => {
          $('gpuVram').value = 24;
          $('modelB').value = 13;
          $('precision').value = 'INT8';
          $('contextLen').value = 8192;
          $('kvPerToken').value = 0.5;
          $('overhead').value = 15;
          $('batchSize').value = 1;
          $('kvScaling').value = (13 / 7).toFixed(1);
          calculate();
        });
        $('preset70B').addEventListener('click', () => {
          $('gpuVram').value = 80;
          $('modelB').value = 70;
          $('precision').value = 'Q4_K_M';
          $('contextLen').value = 4096;
          $('kvPerToken').value = 0.5;
          $('overhead').value = 15;
          $('batchSize').value = 1;
          $('kvScaling').value = (70 / 7).toFixed(1);
          calculate();
        });
      };

      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>
